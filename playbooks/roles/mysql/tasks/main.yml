---
- name: set host list
  set_fact:  
    db_host: "{{ item }}"
  with_inventory_hostnames:
      - mysqldb
- debug: msg={{ db_host }}
  become: true

- name: upgrade all packages
  shell: yum update -y
  args:
   warn: false 

- name: ensure a list of packages installed
  yum:
   name: "{{ packages }}"

- name: install amazon extras
  shell: amazon-linux-extras install -y lamp-mariadb10.2-php7.2 php7.2

- name: set host list
  set_fact:  
    db_host: "{{ item }}"
  with_inventory_hostnames:
      - database
- debug: "msg={{ db_host }}"
  become: true
  ignore_errors: true


- name: Create a new database with name {{ db_name }}
  mysql_db:
   name: "{{ db_name }}"
   state: present
   login_user: admin
   login_password: admin123
   login_host: "{{ db_host }}"
   login_port: 3306


- name: Create database user with password and all database privileges and 'WITH GRANT OPTION'
  mysql_user:
   name: testusr
   password: pass123
   priv: "bname.*:ALL,GRANT"
   state: present
   login_host: "{{ db_host }}"
   login_user: admin
   login_password: admin123
   login_port: 3306

- name: generate table.sql
  template:
   src: create_table.j2
   dest: /tmp/table.sql
   mode: 0777

- name: Import table.sql
  mysql_db:
    state: import
    name: all
    target: /tmp/table.sql
